<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Animals Park AR</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.rawgit.com/jeromeetienne/ar.js/2.0.1/aframe/build/aframe-ar.min.js"></script>
    <script src="https://unpkg.com/aframe-gesture-detector/dist/aframe-gesture-detector.min.js"></script>
    <style>
      body, html {
        margin: 0;
        overflow: hidden;
        width: 100%;
        height: 100%;
      }
    </style>
  </head>
  <body>
    <a-scene
      embedded
      vr-mode-ui="enabled: false"
      arjs="sourceType: webcam; debugUIEnabled: false;"
      device-orientation-permission-ui="enabled: true"
      gesture-detector
      environment="preset: none"
      renderer="logarithmicDepthBuffer: true"
    >
      <a-assets>
        <!-- Sounds -->
        <audio id="elephant-sound" src="assets/sounds/elephant.mp3" preload="auto"></audio>
        <audio id="tiger-sound" src="assets/sounds/tiger.mp3" preload="auto"></audio>
        <audio id="rhino-sound" src="assets/sounds/rhino.mp3" preload="auto"></audio>
        <audio id="muskcow-sound" src="assets/sounds/muskcow.mp3" preload="auto"></audio>

        <!-- Models -->
        <a-asset-item id="elephant-model" src="assets/models/elephant.glb"></a-asset-item>
        <a-asset-item id="tiger-model" src="assets/models/tiger.glb"></a-asset-item>
        <a-asset-item id="rhino-model" src="assets/models/rhino.glb"></a-asset-item>
        <a-asset-item id="muskcow-model" src="assets/models/muskcow.glb"></a-asset-item>

        <!-- Grass Texture -->
        <img id="grass-texture" src="assets/textures/grass.jpg" />
      </a-assets>

      <!-- Lights -->
      <a-light type="ambient" color="#666"></a-light>
      <a-light type="directional" intensity="0.8" position="1 1 0"></a-light>

      <!-- Elephant Marker -->
      <a-marker type="pattern" url="assets/markers/elephant_marker.patt">
        <a-entity id="elephant-container" gesture-rotate-scale>

          <a-plane
            src="#grass-texture"
            rotation="-90 0 0"
            width="4"
            height="4"
            repeat="4 4"
            material="side: double"
            position="0 0 0"
          ></a-plane>

          <a-entity
            id="elephant"
            gltf-model="#elephant-model"
            scale="0.8 0.8 0.8"
            rotation="0 180 0"
            position="0 0.1 0"
            animation-mixer
            sound="src: #elephant-sound; autoplay: false; loop: true; volume: 0.5"
            sound-toggle
          ></a-entity>
        </a-entity>
      </a-marker>

      <!-- Tiger Marker -->
      <a-marker type="pattern" url="assets/markers/tiger_marker.patt">
        <a-entity id="tiger-container" gesture-rotate-scale>

          <a-plane
            src="#grass-texture"
            rotation="-90 0 0"
            width="4"
            height="4"
            repeat="4 4"
            material="side: double"
            position="0 0 0"
          ></a-plane>

          <a-entity
            id="tiger"
            gltf-model="#tiger-model"
            scale="0.8 0.8 0.8"
            rotation="0 180 0"
            position="0 0.1 0"
            animation-mixer="clip: Standing"
            sound="src: #tiger-sound; autoplay: false; loop: true; volume: 0.5"
            sound-toggle
          ></a-entity>
        </a-entity>
      </a-marker>

      <!-- Rhino Marker -->
      <a-marker type="pattern" url="assets/markers/rhino_marker.patt">
        <a-entity id="rhino-container" gesture-rotate-scale>

          <a-plane
            src="#grass-texture"
            rotation="-90 0 0"
            width="4"
            height="4"
            repeat="4 4"
            material="side: double"
            position="0 0 0"
          ></a-plane>

          <a-entity
            id="rhino"
            gltf-model="#rhino-model"
            scale="0.8 0.8 0.8"
            rotation="0 180 0"
            position="0 0.1 0"
            animation-mixer
            sound="src: #rhino-sound; autoplay: false; loop: true; volume: 0.5"
            sound-toggle
          ></a-entity>
        </a-entity>
      </a-marker>

      <!-- Musk Cow Marker -->
      <a-marker type="pattern" url="assets/markers/muskcow_marker.patt">
        <a-entity id="muskcow-container" gesture-rotate-scale>

          <a-plane
            src="#grass-texture"
            rotation="-90 0 0"
            width="4"
            height="4"
            repeat="4 4"
            material="side: double"
            position="0 0 0"
          ></a-plane>

          <a-entity
            id="muskcow"
            gltf-model="#muskcow-model"
            scale="0.8 0.8 0.8"
            rotation="0 180 0"
            position="0 0.1 0"
            animation-mixer
            sound="src: #muskcow-sound; autoplay: false; loop: true; volume: 0.5"
            sound-toggle
          ></a-entity>
        </a-entity>
      </a-marker>

      <a-entity camera></a-entity>
    </a-scene>

    <script>
      // Custom component to handle drag rotate and pinch scale on marker container
      AFRAME.registerComponent('gesture-rotate-scale', {
        init: function () {
          this.isDragging = false;
          this.lastX = 0;
          this.lastY = 0;

          const el = this.el;

          // Mouse Events
          el.sceneEl.canvas.addEventListener('mousedown', (e) => {
            this.isDragging = true;
            this.lastX = e.clientX;
            this.lastY = e.clientY;
          });
          window.addEventListener('mouseup', () => {
            this.isDragging = false;
          });
          el.sceneEl.canvas.addEventListener('mousemove', (e) => {
            if (!this.isDragging) return;
            let deltaX = e.clientX - this.lastX;
            let deltaY = e.clientY - this.lastY;
            el.object3D.rotation.y += deltaX * 0.01;
            el.object3D.rotation.x += deltaY * 0.01;
            this.lastX = e.clientX;
            this.lastY = e.clientY;
          });

          // Touch Events
          el.sceneEl.canvas.addEventListener('touchstart', (e) => {
            this.isDragging = true;
            this.lastX = e.touches[0].clientX;
            this.lastY = e.touches[0].clientY;
          });
          el.sceneEl.canvas.addEventListener('touchend', () => {
            this.isDragging = false;
          });
          el.sceneEl.canvas.addEventListener('touchmove', (e) => {
            if (!this.isDragging) return;
            let deltaX = e.touches[0].clientX - this.lastX;
            let deltaY = e.touches[0].clientY - this.lastY;
            el.object3D.rotation.y += deltaX * 0.01;
            el.object3D.rotation.x += deltaY * 0.01;
            this.lastX = e.touches[0].clientX;
            this.lastY = e.touches[0].clientY;
          });
        }
      });

      // Sound toggle component
      AFRAME.registerComponent('sound-toggle', {
        init: function () {
          this.soundPlaying = false;
          this.el.addEventListener('click', (event) => {
            event.stopPropagation();
            const sound = this.el.components.sound;
            if (!sound) {
              console.warn(`No sound component found on ${this.el.id}`);
              return;
            }
            if (this.soundPlaying) {
              sound.pauseSound();
              console.log(`Sound paused on ${this.el.id}`);
            } else {
              sound.playSound();
              console.log(`Sound played on ${this.el.id}`);
            }
            this.soundPlaying = !this.soundPlaying;
          });
          console.log(`sound-toggle registered on ${this.el.id || this.el.tagName}`);
        }
      });

      // Play sounds on first tap for mobile autoplay policy
      window.addEventListener('DOMContentLoaded', () => {
        document.querySelector('a-scene').addEventListener('loaded', () => {
          document.body.addEventListener('click', () => {
            ['elephant', 'tiger', 'rhino', 'muskcow'].forEach(id => {
              const entity = document.querySelector('#' + id);
              if (entity && entity.components.sound && !entity.components.sound.isPlaying) {
                entity.components.sound.playSound();
                if (entity.components['sound-toggle']) {
                  entity.components['sound-toggle'].soundPlaying = true;
                }
                console.log(`Auto-playing sound for ${id}`);
              }
            });
          }, { once: true });
        });
      });
    </script>
  </body>
</html>

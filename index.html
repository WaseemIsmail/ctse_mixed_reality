<!DOCTYPE html>
<html>
  <head>
    <title>Animals Park AR - Elephant Interactive</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.rawgit.com/jeromeetienne/ar.js/2.0.1/aframe/build/aframe-ar.min.js"></script>
    <script src="https://unpkg.com/aframe-gesture-detector/dist/aframe-gesture-detector.min.js"></script>
    <style>
      body, html { margin: 0; overflow: hidden; width: 100%; height: 100%; }
    </style>
  </head>
  <body>
    <a-scene
      embedded
      vr-mode-ui="enabled: false"
      arjs="sourceType: webcam; debugUIEnabled: false;"
      device-orientation-permission-ui="enabled: true"
      gesture-detector
    >
      <a-assets>
        <audio id="elephant-sound" src="assets/sounds/elephant.mp3" preload="auto"></audio>
      </a-assets>

      <a-marker type="pattern" url="assets/markers/elephant_marker.patt">
        <a-entity id="elephant-container" rotatable scalable>

          <a-entity
            id="elephant"
            gltf-model="assets/models/elephant.glb"
            scale="0.8 0.8 0.8"
            rotation="0 180 0"
            position="0 0.1 0"
            animation-mixer
            sound="src: #elephant-sound; autoplay: false; loop: true; volume: 0.5"
            sound-toggle
            animation__idle="property: rotation; to: 0 360 0; dur: 5000; loop: true; easing: linear"
            animation__walk="property: position; to: 1 0 0; dur: 3000; loop: true; easing: linear"
            visible="true"
          ></a-entity>
        </a-entity>
      </a-marker>

      <a-entity camera></a-entity>
    </a-scene>

    <script>
     
      AFRAME.registerComponent('rotatable', {
        init: function () {
          this.rotation = this.el.getAttribute('rotation') || {x: 0, y: 0, z: 0};
          this.handleDragMove = this.handleDragMove.bind(this);
          this.el.sceneEl.addEventListener('dragmove', this.handleDragMove);
        },
        handleDragMove: function (event) {
          if (event.target !== this.el) return;
          const ROTATION_SPEED = 0.5;
          this.rotation.x -= event.detail.delta.y * ROTATION_SPEED;
          this.rotation.y += event.detail.delta.x * ROTATION_SPEED;
          this.rotation.x = Math.min(Math.max(this.rotation.x, -90), 90);
          this.el.setAttribute('rotation', this.rotation);
        },
        remove: function () {
          this.el.sceneEl.removeEventListener('dragmove', this.handleDragMove);
        }
      });

      AFRAME.registerComponent('scalable', {
        init: function () {
          this.scale = this.el.getAttribute('scale') || {x: 1, y: 1, z: 1};
          this.handlePinchMove = this.handlePinchMove.bind(this);
          this.el.sceneEl.addEventListener('pinchmove', this.handlePinchMove);
        },
        handlePinchMove: function (event) {
          if (event.target !== this.el) return;
          const SCALE_SPEED = 0.01;
          let scaleChange = event.detail.scaleChange * SCALE_SPEED;
          this.scale.x = Math.min(Math.max(this.scale.x * scaleChange, 0.2), 3);
          this.scale.y = Math.min(Math.max(this.scale.y * scaleChange, 0.2), 3);
          this.scale.z = Math.min(Math.max(this.scale.z * scaleChange, 0.2), 3);
          this.el.setAttribute('scale', this.scale);
        },
        remove: function () {
          this.el.sceneEl.removeEventListener('pinchmove', this.handlePinchMove);
        }
      });

      AFRAME.registerComponent('sound-toggle', {
        init: function () {
          this.soundPlaying = false;
          this.el.addEventListener('click', () => {
            const sound = this.el.components.sound;
            if (!sound) return;
            if (this.soundPlaying) {
              sound.pauseSound();
            } else {
              sound.playSound();
            }
            this.soundPlaying = !this.soundPlaying;
          });
        }
      });

      document.body.addEventListener('click', () => {
        const elephant = document.querySelector('#elephant');
        if (elephant) {
          const soundComp = elephant.components.sound;
          if (soundComp && !soundComp.isPlaying) {
            soundComp.playSound();
            elephant.components['sound-toggle'].soundPlaying = true;
          }
        }
      }, { once: true });
      let animationState = "idle";  

      const elephant = document.querySelector('#elephant');
      elephant.addEventListener('click', () => {
        if (animationState === "idle") {
          elephant.setAttribute('animation__walk', {
            property: 'position',
            to: '1 0 0',
            dur: 3000,
            loop: true,
            easing: 'linear'
          });
          elephant.setAttribute('animation__idle', { enabled: false });
          animationState = "walk";
        } else {
          elephant.setAttribute('animation__walk', { enabled: false });
          elephant.setAttribute('animation__idle', {
            property: 'rotation',
            to: '0 360 0',
            dur: 5000,
            loop: true,
            easing: 'linear'
          });
          animationState = "idle";
        }
      });
    </script>
  </body>
</html>
